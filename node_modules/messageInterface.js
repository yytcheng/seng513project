//var dbAccess = require('dbAccess');
//var url = require('url');
var messages = require('message');

var ListMessages = exports.ListMessages = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 * @param issue Issue to display
 */
function displayMessagesPage(response, user) {
	// Get the inbox messages
	messages.getMessages(user, 0, function(error, msgList) {
		var inboxMsgListHtml = '';
		if(msgList) {
			// for (var i = 0; i < msgList.length; i++) {
				// inboxMsgListHtml += "<tr align=\"center\"><td bgcolor=\"#F1F1F1\" align=\"left\" width=\"75%\"><font size=\"2\"><a href=\"viewMessage?msgid=";
				// inboxMsgListHtml += msgList[i].id;
				// inboxMsgListHtml += "\">" + msgList[i].subject;
				// inboxMsgListHtml += "</a></font></td><td bgcolor=\"#DFDFDF\" width=\"25%\" align=\"center\"><font size=\"2\">";
				// inboxMsgListHtml += msgList[i].user + "</font></td><td bgcolor=\"#F1F1F1\" align=\"left\" nowrap=\"\"><span class=\"smaller\">";
				// inboxMsgListHtml += msgList[i].date + "</span></td></tr>";
			// }
		}
		var variables = {
			title: 'dori',
			user: user,
			inboxMsgList : msgList
		}
		response.render('views/listMessages.html', variables);
	});
	
	// return function(error)
	// {
		// var user = users[0];
		// //Check if the user has already voted
		// var sqlAlreadyVoted = "SELECT * FROM votes WHERE user_id = " + g_UserId	 + " AND issue_id = " + issue['id'];
		
		// dbAccess.runQuery(sqlAlreadyVoted, function(error, rows_vote)
		// {			
			// if (error) throw error;
			
			// if (rows_vote.length == 1)
			// {
				// g_UserVote = rows_vote[0]['vote'];	
			// }
			
			// variables = {
				// quickTaskButtons_partial: 'views/layouts/partials/quickTaskButtons_partial.html',
				// quickTaskButtons: {id: issue.id},
			
				// title: issue.title,
				// created: issue.created,
				// user: user,
				// user_id: user.id,
				// user_name: user.name,
				// status: issue.status,
				// location: issue.location,
				// description: issue.description,
				// link: issue.link,
				// id: issue.id,
				// userHasVoted: g_UserVote != -1,
				// userLiked: g_UserVote == 0
			// }
			
			// response.render('views/viewIssue.html', variables);

		// }); 
	// };
}

/**
 * Retrieve the user corresponding to the issue
 * @param response Response object to send the data
 */
function findIssueCreator(response) {
		return function(error, rows) {
			if (error) throw error;
			var issue = rows[0];

			dbAccess.runQuery('SELECT * FROM users WHERE id=' + issue['user_id'], displayPage(response, issue));

	};
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
ListMessages.display = function(request, response) {
	//var parsedURL = url.parse(request.url, true);
	
	//util.log(parsedURL);
	
	// TODO: check the session id from the cookie, then look up which user it is that way
	// This will do for now though..
	
	// Get logged-in user and call display
	request.getUser(function(error, user){
		if(error)
			util.log("Error getting user in messageInterface.display. " + error);
		
		if (user) {
			// Display msgs
			displayMessagesPage(response, user.id);
		}
	});
};
