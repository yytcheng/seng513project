var dbAccess = require('dbAccess');
var url = require('url');

var ViewProfile = exports.ViewProfile = function() {};

/**
 * Display a profile page
 * @param request Request object from the client
 * @param response Response object to send the data
 */
ViewProfile.display = function(request, response)
{
	var parsedURL = url.parse(request.url, true);
	var id = parsedURL.query.id;
	dbAccess.find('users', { conditions:['id="' + id + '"'] }, function(error, users)
	//request.getUser(function(error,user)
	{
		if(error || users[0] == undefined){
			variables = {found: false, user_id: id}
			response.render('views/viewProfile.html', variables);
		}
		
		// If user_id is found, display personal information and the list of issues
		else if(users)
		{
			user = users[0];
			dbAccess.find('issues', { conditions:['user_id="' + user.id + '"'], orderby:'created desc' }, function(error, issues)
			{
				variables = {
					found: true,
					name: user.name,
					neighborhood: user.neighborhood || '',
					postal_code: user.postal_code || '',
					facebook_account: user.facebook_account || 'None',
					twitter_account: user.twitter_account || 'None',
					issues_list: issues
				}
				response.render('views/viewProfile.html', variables);
			});
		}
	});
}
